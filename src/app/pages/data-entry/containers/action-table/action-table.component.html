<div>
  <div *ngIf="!(configurationLoaded$ | async) || !(configuration$ | async)">
    <mat-card>
      <mat-card-content>
        <div>Discovering Configurations</div>
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </mat-card-content>
    </mat-card>
  </div>

  <div
    class="action-table-container border-top border-left border-right"
    *ngIf="configurationLoaded$ | async"
  >
    <div class="action-table-header">
      <div class="d-flex">
        <button mat-stroked-button>
          <div class="d-flex justify-content-between align-items-center">
            <span>Status</span>
            <mat-icon inline="true">keyboard_arrow_down</mat-icon>
          </div>
        </button>
        <button class="ml-2" mat-stroked-button>
          <div class="d-flex justify-content-between align-items-center">
            <span>Responsible Person</span>
            <mat-icon inline="true">keyboard_arrow_down</mat-icon>
          </div>
        </button>
        <!-- <app-legend></app-legend> -->
      </div>
      <div>
        <button class="text-muted" mat-icon-button>
          <mat-icon (click)="openColumnConfigDialog()">settings</mat-icon>
        </button>
        <button
          class="text-muted"
          [matMenuTriggerFor]="moreTableOptions"
          mat-icon-button
        >
          <mat-icon>more_horiz</mat-icon>
        </button>

        <mat-menu #moreTableOptions="matMenu">
          <mat-list>
            <div mat-subheader>Download</div>
            <mat-list-item>
              <div mat-line>Excel</div>
            </mat-list-item>
            <mat-list-item>
              <div mat-line>CSV</div>
            </mat-list-item>
            <mat-list-item>
              <div mat-line>Print PDF</div>
            </mat-list-item>
          </mat-list>
        </mat-menu>
      </div>
    </div>
    <table
      #tableElement
      class="table"
      *ngIf="configuration$ | async as configuration"
    >
      <tr>
        <th class="text-muted">#</th>
        <th
          *ngFor="let dataElement of configuration.dataElements"
          [hidden]="dataElement.isHidden || !(columnSettings$ | async)[dataElement.id]"
          [ngClass]="{
            'bna-column': !dataElement?.isActionTrackerColumn,
            'text-muted': true
          }"
        >
          {{ dataElement.name }}
        </th>
        <th class="text-muted" *ngIf="!isActionTracking">Status</th>
        <th *ngIf="!isActionTracking"></th>
        <th
          class="text-muted"
          style="border-left: 1px solid #dee2e6;"
          *ngIf="!isActionTracking"
        ></th>
        <ng-container *ngIf="isActionTracking">
          <th
            class="text-muted border-left"
            *ngFor="let quarter of actionTrackingQuarters$ | async"
            style="width: 7% !important;"
          >
            {{ quarter.name || 'Quarters Not Supported' }}
          </th>
        </ng-container>
      </tr>

      <tbody *ngIf="dataLoading$ | async">
        <tr>
          <td colspan="100%">
            <div>{{ (notification$ | async)?.message }}</div>
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          </td>
        </tr>
      </tbody>

      <tbody *ngIf="!(dataLoading$ | async) && !(dataLoaded$ | async)">
        <tr>
          <td colspan="100%">
            <span>
              <i>
                Select Intervention, Period and Organization Unit to see actions
              </i>
            </span>
          </td>
        </tr>
      </tbody>

      <tbody
        *ngIf="
          (dataLoaded$ | async) &&
          (data$ | async)?.length == 0 &&
          !(dataLoading$ | async)
        "
      >
        <tr>
          <td colspan="100%">
            <span>
              <i>
                There are no possible solutions based on parameters selected.
              </i>
            </span>
          </td>
        </tr>
      </tbody>

      <tbody *ngIf="columnSettings$ | async as columnSettings">
        <tr *ngFor="let actionDataItem of data$ | async; let i = index">
          <td>{{ i + 1 }}</td>
          <td
            matTooltip="Click row to see full text or truncate"
            [matTooltipPosition]="'after'"
            *ngFor="let actionDataElement of configuration.dataElements"
            [ngClass]="{
              'bna-column': !actionDataElement?.isActionTrackerColumn
            }"
            [hidden]="
              actionDataElement.isHidden ||
              (actionDataElement.isNotTrackingColumn && isActionTracking) ||
              !(columnSettings$ | async)[actionDataElement.id]
            "
            (click)="toggleTruncationStatus(actionDataItem)"
          >
            {{
              (actionDataItem?.dataValues)[actionDataElement.id]
                | textTruncate: 40:actionDataItem.truncateStatus
            }}
          </td>
          <td
            *ngIf="!isActionTracking"
            class="px-1"
            [style.background-color]="
              actionDataItem.latestStatus
                | colorize: (legendSetStatus$ | async):'#fff'
            "
          >
            {{
              actionDataItem.latestStatus
                | convertLegendId: (legendSetStatus$ | async)
            }}
          </td>
          <td *ngIf="!isActionTracking" class="px-1" style="width:70px">
            <ng-container *ngIf="actionDataItem.attributes">
              <span
                title="Click to edit action"
                class="text-success mr-1"
                style="cursor: pointer;"
                mat-icon-button
                (click)="
                  onEditAction(
                    $event,
                    actionDataItem,
                    configuration.dataElements
                  )
                "
              >
                <mat-icon>edit</mat-icon>
              </span>
              <span
                title="Click to delete action"
                class="text-danger ml-1"
                style="cursor: pointer;"
                mat-icon-button
                (click)="onDeleteAction($event, actionDataItem)"
              >
                <mat-icon>delete</mat-icon>
              </span>
            </ng-container>
          </td>
          <td
            class="action-controls-column"
            *ngIf="actionDataItem.rowspan && !isActionTracking"
            [attr.rowspan]="actionDataItem.rowspan"
            style="border-left: 1px solid #dee2e6;"
          >
            <div class="add-action-block">
              <button mat-stroked-button>
                <mat-icon>bar_chart</mat-icon>
                <span>Progress</span>
              </button>
              <br />
              <button
                class="mt-2"
                title="Click to add new action"
                mat-stroked-button
                (click)="
                  onAddAction(
                    $event,
                    actionDataItem,
                    configuration.dataElements
                  )
                "
              >
                <mat-icon>add</mat-icon>
                <span>Add new</span>
              </button>
            </div>
          </td>

          <ng-container *ngIf="isActionTracking">
            <ng-container
              *ngIf="
                programStageConfiguration$
                  | async as actionTrackingConfigurations
              "
            >
              <td
                class="action-tracking-column"
                *ngFor="
                  let actionTrackingItem of actionDataItem.actionTrackingColumns;
                  let first = first
                "
                (click)="toggleTruncationStatus(actionDataItem)"
              >
                <div
                  *ngFor="
                    let actionTrackingConfiguration of actionTrackingConfigurations
                  "
                  [hidden]="
                    (!first && !actionDataItem.hasEvents) ||
                    !actionTrackingItem.hasEvent
                  "
                  (dblclick)="
                    onEditActionTracking(
                      $event,
                      actionDataItem,
                      actionTrackingItem,
                      actionTrackingConfigurations
                    )
                  "
                  matTooltip="Double Click to Edit"
                  matTooltipDisabled="{{
                    actionTrackingItem.isCurrentQuater ? false : true
                  }}"
                  [matTooltipPosition]="'after'"
                >
                  <p class="my-0">
                    <b>{{
                      actionTrackingConfiguration.shortName ||
                        actionTrackingConfiguration.name
                    }}</b>
                  </p>
                  <p
                    class="mb-1"
                    [style.color]="
                      actionTrackingItem[
                        actionTrackingConfiguration.formControlName
                      ] | colorize: (legendSetStatus$ | async):'#000'
                    "
                  >
                    {{
                      actionTrackingItem[
                        actionTrackingConfiguration.formControlName
                      ]
                        | convertLegendId: (legendSetStatus$ | async)
                        | textTruncate: 40:actionDataItem.truncateStatus
                    }}
                  </p>
                </div>
                <div
                  *ngIf="
                    !actionTrackingItem.hasEvent && actionDataItem.hasQuarters
                  "
                >
                  <button
                    title="Click to add new review"
                    mat-icon-button
                    (click)="
                      onEditActionTracking(
                        $event,
                        actionDataItem,
                        actionTrackingItem,
                        actionTrackingConfigurations
                      )
                    "
                  >
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>
</div>
